#!/usr/bin/env python3
"""
VISUAL EXPLOITATION CAPTURE SYSTEM
Adds screenshot and video recording capabilities to exploit execution
"""

import subprocess
import time
import os
import json
from datetime import datetime

class VisualExploitationCapture:
    def __init__(self):
        self.capture_dir = "./exploitation_captures"
        self.ensure_capture_directory()
        
    def ensure_capture_directory(self):
        """Create directory for storing captures"""
        if not os.path.exists(self.capture_dir):
            os.makedirs(self.capture_dir)
            print(f"Created capture directory: {self.capture_dir}")
    
    def check_screenshot_capability(self):
        """Check if screenshot capture is available"""
        try:
            # Check for screenshot tools
            tools = ['screencapture', 'gnome-screenshot', 'scrot', 'import']
            available_tools = []
            
            for tool in tools:
                try:
                    subprocess.run(['which', tool], capture_output=True, check=True)
                    available_tools.append(tool)
                except subprocess.CalledProcessError:
                    continue
            
            if available_tools:
                print(f"‚úÖ Screenshot capability available: {available_tools}")
                return True, available_tools
            else:
                print("‚ùå No screenshot tools found")
                return False, []
                
        except Exception as e:
            print(f"‚ùå Screenshot check failed: {e}")
            return False, []
    
    def check_video_capability(self):
        """Check if video recording is available"""
        try:
            # Check for video recording tools
            tools = ['ffmpeg', 'recordmydesktop', 'obs']
            available_tools = []
            
            for tool in tools:
                try:
                    subprocess.run(['which', tool], capture_output=True, check=True)
                    available_tools.append(tool)
                except subprocess.CalledProcessError:
                    continue
            
            if available_tools:
                print(f"‚úÖ Video capability available: {available_tools}")
                return True, available_tools
            else:
                print("‚ùå No video recording tools found")
                return False, []
                
        except Exception as e:
            print(f"‚ùå Video check failed: {e}")
            return False, []
    
    def install_screenshot_tools(self):
        """Install screenshot capture tools"""
        print("üîß Installing screenshot capture tools...")
        
        install_commands = [
            "sudo apt-get update",
            "sudo apt-get install -y scrot imagemagick gnome-screenshot"
        ]
        
        for cmd in install_commands:
            try:
                print(f"Running: {cmd}")
                subprocess.run(cmd.split(), check=True)
            except subprocess.CalledProcessError as e:
                print(f"Failed to run {cmd}: {e}")
                return False
        
        print("‚úÖ Screenshot tools installed successfully")
        return True
    
    def install_video_tools(self):
        """Install video recording tools"""
        print("üîß Installing video recording tools...")
        
        install_commands = [
            "sudo apt-get update",
            "sudo apt-get install -y ffmpeg recordmydesktop"
        ]
        
        for cmd in install_commands:
            try:
                print(f"Running: {cmd}")
                subprocess.run(cmd.split(), check=True)
            except subprocess.CalledProcessError as e:
                print(f"Failed to run {cmd}: {e}")
                return False
        
        print("‚úÖ Video tools installed successfully")
        return True
    
    def capture_screenshot(self, filename_prefix="exploit"):
        """Capture a screenshot"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"{self.capture_dir}/{filename_prefix}_{timestamp}.png"
        
        # Try different screenshot methods
        screenshot_commands = [
            ['scrot', filename],
            ['gnome-screenshot', '-f', filename],
            ['import', '-window', 'root', filename]
        ]
        
        for cmd in screenshot_commands:
            try:
                subprocess.run(cmd, check=True, capture_output=True)
                print(f"‚úÖ Screenshot captured: {filename}")
                return filename
            except subprocess.CalledProcessError:
                continue
        
        print("‚ùå Failed to capture screenshot")
        return None
    
    def start_video_recording(self, filename_prefix="exploit_video"):
        """Start video recording"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"{self.capture_dir}/{filename_prefix}_{timestamp}.mp4"
        
        # Try ffmpeg for video recording
        try:
            cmd = ['ffmpeg', '-f', 'x11grab', '-r', '30', '-s', '1920x1080', '-i', ':0.0', filename]
            process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            print(f"‚úÖ Video recording started: {filename}")
            return filename, process
        except Exception as e:
            print(f"‚ùå Failed to start video recording: {e}")
            return None, None
    
    def stop_video_recording(self, process):
        """Stop video recording"""
        if process:
            process.terminate()
            process.wait()
            print("‚úÖ Video recording stopped")
    
    def execute_exploit_with_capture(self, html_file):
        """Execute exploit and capture evidence"""
        print(f"üöÄ Executing exploit: {html_file}")
        
        # Capture before screenshot
        before_screenshot = self.capture_screenshot("before_exploit")
        
        # Start video recording
        video_file, video_process = self.start_video_recording()
        
        # Open HTML file in browser
        try:
            browser_cmd = ['firefox', html_file]  # or 'google-chrome'
            browser_process = subprocess.Popen(browser_cmd)
            
            # Wait for browser to load
            time.sleep(5)
            
            # Capture during exploit
            during_screenshot = self.capture_screenshot("during_exploit")
            
            # Wait more time
            time.sleep(10)
            
            # Capture after exploit
            after_screenshot = self.capture_screenshot("after_exploit")
            
            # Close browser
            browser_process.terminate()
            
        except Exception as e:
            print(f"‚ùå Exploit execution failed: {e}")
        
        # Stop video recording
        if video_process:
            self.stop_video_recording(video_process)
        
        # Generate evidence report
        evidence = {
            "exploit_file": html_file,
            "screenshots": {
                "before": before_screenshot,
                "during": during_screenshot,
                "after": after_screenshot
            },
            "video": video_file,
            "timestamp": datetime.now().isoformat()
        }
        
        # Save evidence report
        evidence_file = f"{self.capture_dir}/exploitation_evidence_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(evidence_file, 'w') as f:
            json.dump(evidence, f, indent=2)
        
        print(f"‚úÖ Evidence report saved: {evidence_file}")
        return evidence

def main():
    """Main execution"""
    print("üéØ VISUAL EXPLOITATION CAPTURE SYSTEM")
    print("=" * 50)
    
    capturer = VisualExploitationCapture()
    
    # Check capabilities
    screenshot_available, screenshot_tools = capturer.check_screenshot_capability()
    video_available, video_tools = capturer.check_video_capability()
    
    print(f"\nüìä CAPABILITY ASSESSMENT:")
    print(f"Screenshot: {'‚úÖ Available' if screenshot_available else '‚ùå Not Available'}")
    print(f"Video: {'‚úÖ Available' if video_available else '‚ùå Not Available'}")
    
    if not screenshot_available:
        print("\nüîß Installing screenshot tools...")
        if capturer.install_screenshot_tools():
            screenshot_available = True
    
    if not video_available:
        print("\nüîß Installing video tools...")
        if capturer.install_video_tools():
            video_available = True
    
    # Test with Vectra exploit
    exploit_file = "./vectra_clickjacking_exploit_test.html"
    if os.path.exists(exploit_file):
        print(f"\nüöÄ Testing exploit execution with capture...")
        evidence = capturer.execute_exploit_with_capture(exploit_file)
        print(f"‚úÖ Exploit execution completed")
        print(f"üì∏ Screenshots: {len([s for s in evidence['screenshots'].values() if s])}")
        print(f"üé• Video: {'‚úÖ' if evidence['video'] else '‚ùå'}")
    else:
        print(f"‚ùå Exploit file not found: {exploit_file}")

if __name__ == "__main__":
    main()
