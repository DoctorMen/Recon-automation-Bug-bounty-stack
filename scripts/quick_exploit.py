#!/usr/bin/env python3
"""
Quick Exploit Command - Ultra-Fast Parallel Exploitation
Drastically reduces exploitation time from hours to minutes using parallel computation
"""

import json
import asyncio
import sys
from pathlib import Path

# Add scripts directory to path
SCRIPT_DIR = Path(__file__).parent
REPO_ROOT = SCRIPT_DIR.parent
sys.path.insert(0, str(SCRIPT_DIR))

from ultra_fast_exploiter import UltraFastExploiter

def main():
    """Quick exploit command - runs ultra-fast parallel exploitation"""
    print("=" * 70)
    print("üöÄ ULTRA-FAST PARALLEL EXPLOITATION")
    print("=" * 70)
    print()
    
    # Find discovered endpoints
    endpoints_file = REPO_ROOT / "output" / "blackhole_code4rena" / "discovered_endpoints.json"
    
    if not endpoints_file.exists():
        # Try alternative locations
        alt_paths = [
            REPO_ROOT / "output" / "immediate_roi" / "api_vulnerabilities.json",
            REPO_ROOT / "output" / "http.json"
        ]
        
        endpoints = []
        for alt_path in alt_paths:
            if alt_path.exists():
                print(f"[*] Loading endpoints from: {alt_path}")
                with open(alt_path) as f:
                    data = json.load(f)
                    if isinstance(data, list):
                        endpoints = [item.get("url") or item.get("input") or item for item in data if isinstance(item, str) or item.get("url") or item.get("input")]
                    elif isinstance(data, dict):
                        endpoints = data.get("endpoints", [])
                break
        
        if not endpoints:
            print("‚ùå No endpoints found. Run discovery first:")
            print("   python3 scripts/immediate_roi_hunter.py")
            return
    else:
        print(f"[*] Loading endpoints from: {endpoints_file}")
        with open(endpoints_file) as f:
            endpoints = json.load(f)
    
    print(f"[*] Found {len(endpoints)} endpoints")
    
    # Generate test cases
    test_cases = [
        {"type": "auth_bypass"},
        {"type": "idor"},
        {"type": "rate_limit"},
        {"type": "api_mass_assignment", "payload": {"role": "admin", "is_admin": True}},
        {"type": "generic"}
    ]
    
    print(f"[*] Test cases: {len(test_cases)}")
    print(f"[*] Max concurrent: 100")
    print()
    
    # Create exploiter
    output_dir = REPO_ROOT / "output" / "blackhole_code4rena"
    exploiter = UltraFastExploiter(output_dir, max_concurrent=100)
    
    # Run exploitation
    print("[*] Starting ultra-fast parallel exploitation...")
    print()
    
    try:
        # Try async first (fastest)
        confirmed = asyncio.run(exploiter.exploit_all_async(endpoints, test_cases))
    except Exception as e:
        print(f"‚ö†Ô∏è Async failed, using sync mode: {e}")
        confirmed = exploiter.exploit_all_sync(endpoints, test_cases)
    
    # Summary
    print()
    print("=" * 70)
    print("‚úÖ EXPLOITATION COMPLETE")
    print("=" * 70)
    print(f"Confirmed vulnerabilities: {len(confirmed)}")
    print(f"Estimated value: ${sum(r.get('value', 0) for r in confirmed):,}")
    print()
    print(f"Results saved to: {output_dir / 'exploitation'}")
    print("=" * 70)

if __name__ == "__main__":
    main()

